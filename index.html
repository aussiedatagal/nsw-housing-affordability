<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NSW Housing Affordability Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="font-sans bg-gray-50 flex flex-col h-screen">

    <header class="bg-white border-b border-gray-200 shadow-sm w-full z-20">
        <div class="max-w-7xl mx-auto">
            <div class="flex items-center justify-between p-3 md:p-4">
                <div class="flex-1">
                    <h1 class="text-lg md:text-xl font-bold text-gray-800">NSW Housing Affordability Map</h1>
                </div>
                <button id="header-toggle" class="ml-4 p-1 text-gray-500 hover:text-gray-700 md:hidden">
                    <svg id="header-chevron" class="w-5 h-5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </button>
            </div>
            <div id="header-description" class="px-3 md:px-4 pb-3 md:pb-4">
                <p class="text-xs md:text-sm text-gray-600">
                    Find out where you can afford to live in NSW. Enter your income and expenses to see which postcodes 
                    are affordable based on the <a href="https://www.abs.gov.au/statistics/detailed-methodology-information/concepts-sources-methods/survey-income-and-housing-user-guide-australia/2019-20/housing#housing-affordability" target="_blank" class="text-blue-600 hover:underline">30% housing cost rule</a>. Green areas are affordable (≤30% of gross income), red areas exceed 
                    recommended housing costs. Black areas indicate negative remaining income after costs.
                </p>
            </div>
        </div>
    </header>

    <main class="flex-grow relative h-full">
        <div id="map-container" class="w-full h-full">
            <div id="map"></div>

            <div id="controls" class="info-card absolute top-4 right-4 rounded-xl w-72 md:w-80 z-[1000] max-h-[calc(100vh-8rem)] overflow-y-auto">
                <div id="controls-header"
                    class="p-4 md:p-5 flex justify-between items-center cursor-pointer hover:bg-gray-100/50 rounded-xl">
                    <h1 class="text-sm font-bold text-gray-800">Customise</h1>
                    <svg id="controls-chevron" class="w-6 h-6 text-gray-600 transition-transform" fill="none"
                        stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </div>

                <div id="controls-content" class="px-4 md:px-5 pb-4 md:pb-5 border-t border-gray-200 hidden">

                    <!-- Income Section -->
                    <div class="mb-4">
                        <h3 class="text-sm font-semibold text-gray-800 mb-2">Household Income</h3>
                        <div class="space-y-2">
                            <div class="flex flex-col">
                                <label for="annualIncome" class="text-xs font-medium text-gray-700">Annual Household Income (after tax) ($)</label>
                                <input type="number" id="annualIncome" value="0" step="1000"
                                    class="p-2 border border-gray-300 rounded-lg text-sm focus:ring-blue-500 focus:border-blue-500">
                                <span class="text-xs text-gray-500">Enter your net income. We estimate your gross income below (used for the 30% affordability rule).</span>
                            </div>
                            <div class="space-y-1 text-xs">
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600">Annual Gross Income:</span>
                                    <span id="annualGrossIncome" class="font-semibold text-blue-600">$0</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600">Weekly Gross Income:</span>
                                    <span id="weeklyGrossIncome" class="font-semibold text-blue-600">$0</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600">Max Weekly Housing (30% rule):</span>
                                    <span id="maxHousingExpense" class="font-semibold text-orange-600">$0</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600">Weekly Net Income:</span>
                                    <span id="netIncome" class="font-semibold text-green-600">$0</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Housing Type Selection -->
                    <div class="mb-4">
                        <h3 class="text-sm font-semibold text-gray-800 mb-2">Scenario</h3>
                        <div class="flex space-x-4 text-xs">
                            <label><input type="radio" name="housingType" value="rent" checked> Rent</label>
                            <label><input type="radio" name="housingType" value="buy"> Buy</label>
                        </div>
                    </div>

                    <!-- Price Point Selection -->
                    <div class="mb-4">
                        <h3 class="text-sm font-semibold text-gray-800 mb-2">Price Point</h3>
                        <div class="flex flex-col">
                            <select id="pricePoint"
                                class="p-2 border border-gray-300 rounded-lg text-sm focus:ring-blue-500 focus:border-blue-500">
                                <option value="q1">25th percentile (below-average price)</option>
                                <option value="median" selected>50th percentile (average price)</option>
                                <option value="q3">75th percentile (above-average price)</option>
                            </select>
                            <span class="text-xs text-gray-500 mt-1">Choose which price point to use for affordability calculations</span>
                        </div>
                    </div>

                    <!-- Mortgage Settings (shown when buying) -->
                    <div id="mortgageSettings" class="mb-4 hidden">
                        <h3 class="text-sm font-semibold text-gray-800 mb-2">Mortgage Settings</h3>
                        <div class="space-y-2">
                            <div class="flex flex-col">
                                <label for="mortgageType" class="text-xs font-medium text-gray-700">Mortgage Type</label>
                                <select id="mortgageType"
                                    class="p-2 border border-gray-300 rounded-lg text-sm focus:ring-blue-500 focus:border-blue-500">
                                    <option value="PI">Principal & Interest (P+I)</option>
                                    <option value="IO">Interest Only (IO)</option>
                                </select>
                            </div>
                            <div class="flex flex-col">
                                <label for="interestRate" class="text-xs font-medium text-gray-700">Interest Rate (%)</label>
                                <input type="number" id="interestRate" value="6.5" step="0.1"
                                    class="p-2 border border-gray-300 rounded-lg text-sm focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div class="flex flex-col" id="loanTermGroup">
                                <label for="loanTerm" class="text-xs font-medium text-gray-700">Loan Term (Years)</label>
                                <input type="number" id="loanTerm" value="30"
                                    class="p-2 border border-gray-300 rounded-lg text-sm focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div class="flex flex-col">
                                <label class="text-xs font-medium text-gray-700 mb-1">Deposit Input Type</label>
                                <div class="flex space-x-4 mb-2 text-xs">
                                    <label><input type="radio" name="depositType" value="percent" checked> Percentage (%)</label>
                                    <label><input type="radio" name="depositType" value="amount"> Amount ($)</label>
                                </div>
                                <input type="number" id="depositPercent" value="20"
                                    class="p-2 border border-gray-300 rounded-lg text-sm focus:ring-blue-500 focus:border-blue-500"
                                    style="display: block;">
                                <input type="number" id="depositAmount" value="100000"
                                    class="p-2 border border-gray-300 rounded-lg text-sm focus:ring-blue-500 focus:border-blue-500"
                                    style="display: none;">
                            </div>
                        </div>
                    </div>

                    <!-- Living Costs Section -->
                    <div class="mb-4">
                        <h3 class="text-sm font-semibold text-gray-800 mb-2">Weekly Living Costs</h3>
                        <div class="space-y-2">
                            <div class="flex flex-col">
                                <label for="utilities" class="text-xs font-medium text-gray-700">Utilities ($/week)</label>
                                <input type="number" id="utilities" value="0" step="5"
                                    class="p-2 border border-gray-300 rounded-lg text-sm focus:ring-blue-500 focus:border-blue-500">
                                <span class="text-xs text-gray-500">Default: $46 (ABS HES 2019-20, adjusted for inflation)</span>
                            </div>
                            <div class="flex flex-col">
                                <label for="food" class="text-xs font-medium text-gray-700">Food & Groceries ($/week)</label>
                                <input type="number" id="food" value="0" step="5"
                                    class="p-2 border border-gray-300 rounded-lg text-sm focus:ring-blue-500 focus:border-blue-500">
                                <span class="text-xs text-gray-500">Default: $92 (ABS HES 2019-20, adjusted for inflation)</span>
                            </div>
                            <div class="flex flex-col">
                                <label for="transport" class="text-xs font-medium text-gray-700">Transport ($/week)</label>
                                <input type="number" id="transport" value="0" step="5"
                                    class="p-2 border border-gray-300 rounded-lg text-sm focus:ring-blue-500 focus:border-blue-500">
                                <span class="text-xs text-gray-500">Default: $69 (ABS HES 2019-20, adjusted for inflation)</span>
                            </div>
                            <div class="flex flex-col">
                                <label for="other" class="text-xs font-medium text-gray-700">Other Living Costs ($/week)</label>
                                <input type="number" id="other" value="0" step="5"
                                    class="p-2 border border-gray-300 rounded-lg text-sm focus:ring-blue-500 focus:border-blue-500">
                                <span class="text-xs text-gray-500">Insurance, phone, internet, etc. (adjust as needed)</span>
                            </div>
                        </div>
                    </div>

                    <!-- Owner-specific costs (shown when buying) -->
                    <div id="ownerCosts" class="mb-4 hidden">
                        <h3 class="text-sm font-semibold text-gray-800 mb-2">Additional Owner Costs</h3>
                        <div class="space-y-2">
                            <div class="flex flex-col">
                                <label for="strata" class="text-xs font-medium text-gray-700">Strata/Body Corp ($/week)</label>
                                <input type="number" id="strata" value="0" step="5"
                                    class="p-2 border border-gray-300 rounded-lg text-sm focus:ring-blue-500 focus:border-blue-500">
                                <span class="text-xs text-gray-500">Default: $92 (typical for apartments, set to 0 for houses)</span>
                            </div>
                            <div class="flex flex-col">
                                <label for="council" class="text-xs font-medium text-gray-700">Council Rates ($/week)</label>
                                <input type="number" id="council" value="0" step="5"
                                    class="p-2 border border-gray-300 rounded-lg text-sm focus:ring-blue-500 focus:border-blue-500">
                                <span class="text-xs text-gray-500">Default: $46 (average NSW council rates)</span>
                            </div>
                            <div class="flex flex-col">
                                <label for="water" class="text-xs font-medium text-gray-700">Water & Sewer ($/week)</label>
                                <input type="number" id="water" value="0" step="5"
                                    class="p-2 border border-gray-300 rounded-lg text-sm focus:ring-blue-500 focus:border-blue-500">
                                <span class="text-xs text-gray-500">Default: $23 (typical NSW water/sewer charges)</span>
                            </div>
                            <div class="flex flex-col">
                                <label for="maintenance" class="text-xs font-medium text-gray-700">Maintenance ($/week)</label>
                                <input type="number" id="maintenance" value="0" step="5"
                                    class="p-2 border border-gray-300 rounded-lg text-sm focus:ring-blue-500 focus:border-blue-500">
                                <span class="text-xs text-gray-500">Default: $69 (1% of property value annually)</span>
                            </div>
                        </div>
                    </div>

                    <div id="metadata" class="text-xs text-gray-500">
                        <div class="mb-1">Data sources:</div>
                        <div>• Housing data: <a href="https://dcj.nsw.gov.au/about-us/families-and-communities-statistics/housing-rent-and-sales/rent-and-sales-report.html" target="_blank" class="text-blue-600 hover:underline">NSW Dept. of Planning, Housing & Infrastructure</a></div>
                        <div>• Household income: <a href="https://www.abs.gov.au/statistics/measuring-what-matters/measuring-what-matters-themes-and-indicators/prosperous/household-income-and-wealth" target="_blank" class="text-blue-600 hover:underline">ABS Measuring What Matters - Household income and wealth</a></div>
                        <div>• Cost of living: <a href="https://www.abs.gov.au/statistics/economy/price-indexes-and-inflation/consumer-price-index-australia" target="_blank" class="text-blue-600 hover:underline">ABS Household Expenditure Survey 2019-20</a> (adjusted for inflation)</div>
                    </div>
                </div>
            </div>
        </div>
    </main>


    <!-- Mobile popup overlay -->
    <div id="mobile-popup-overlay" class="fixed inset-0 bg-white z-[2000] hidden md:hidden">
        <div class="flex flex-col h-full">
            <!-- Header with back button -->
            <div class="flex items-center justify-between p-4 border-b border-gray-200 bg-white">
                <button id="mobile-popup-back" class="flex items-center text-blue-600 hover:text-blue-800">
                    <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                    Back
                </button>
                <h2 class="text-lg font-bold text-gray-800">Property Details</h2>
                <div class="w-20"></div> <!-- Spacer for centering -->
            </div>
            
            <!-- Content area -->
            <div class="flex-1 overflow-y-auto p-4">
                <div id="mobile-popup-content" class="font-sans">
                    <!-- Content will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <template id="popup-template">
        <div class="p-2 font-sans w-full max-w-xs md:max-w-md break-words">
            <h3 class="text-base font-bold mb-0 leading-tight" id="popup-suburbs"></h3>
            <div class="text-xs text-gray-500 mb-2" id="popup-postcode"></div>

            <div class="mb-2 border-b pb-2">
                <h4 class="text-xs font-bold text-gray-700 mb-1">Weekly Income Breakdown</h4>
                <div class="flex justify-between items-center">
                    <span class="text-xs">Household Income (before tax):</span>
                    <span class="font-semibold text-sm" id="gross-income-weekly"></span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-xs">Household Income (after tax):</span>
                    <span class="font-semibold text-sm" id="net-income-weekly"></span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-xs">After Living Costs:</span>
                    <span class="font-semibold text-sm" id="after-expenses-weekly"></span>
                </div>
            </div>

            <div class="mb-2 border-b pb-2">
                <h4 class="text-xs font-bold text-gray-700 mb-1">Rent Option</h4>
                <div class="flex justify-between items-center">
                    <span class="text-xs">Weekly Rent:</span>
                    <span class="font-semibold text-sm" id="rent-cost-weekly"></span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-xs">Money Left Over:</span>
                    <span class="font-semibold text-sm" id="money-after-rent"></span>
                </div>
            </div>

            <div class="mb-2 border-b pb-2">
                <h4 class="text-xs font-bold text-gray-700 mb-1">Buy Option</h4>
                <div class="flex justify-between items-center">
                    <span class="text-xs">Mortgage Payment:</span>
                    <span class="font-semibold text-sm" id="mortgage-cost-weekly"></span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-xs">Owner Costs:</span>
                    <span class="font-semibold text-sm" id="owner-costs-weekly"></span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-xs">Total Housing Cost:</span>
                    <span class="font-semibold text-sm" id="total-buy-cost-weekly"></span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-xs">Money Left Over:</span>
                    <span class="font-semibold text-sm" id="money-after-buy"></span>
                </div>
            </div>

            <div class="text-xs text-gray-500 mt-2">
                <div>Price Point: <span id="price-point-label"></span></div>
                <div>Sale Price (<span id="sale-price-label"></span>): <span id="median-sale-price-000s"></span></div>
            </div>
        </div>
    </template>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script src="map_app.js"></script>
    <script async src="https://cdn.counter.dev/script.js" data-id="2fd9f514-57b3-4a7e-bcab-1f565aff04d0"
        data-utcoffset="10"></script>

</body>

</html>